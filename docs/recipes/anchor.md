---
title: Anchor
---

# Anchor

[Anchor][AnchorDocs] is a framework for Solana's Sealevel runtime providing several convenient developer tools.
Program architecture is composed of a Program, Instructions, Accounts Deserializers and Accounts.

## Define a Program

### Program and Instructions

A module defining all instructions and respective entries of a Solana program.

The [`#[program]`][Program] attribute indicates the place where each inner method defines an instruction (RPC request) handler. These handlers are the entrypoints to the program that clients may invoke or other programs can invoke.

The [`Context<AccountsDeserializer>`][Context] parameter indicates the instruction's `Context` struct, which is a container generated by the `Accounts Deserializer`.

The `value` parameter indicates an input to the program.

<SolanaCodeGroup>
  <SolanaCodeGroupItem title="Rust" active>

  <template v-slot:default>

@[code](@/code/anchor/define-program/src/lib.rs)

  </template>

  <template v-slot:preview>

@[code](@/code/anchor/define-program/src/define-program-and-instructions.preview.lib.rs)

  </template>

  </SolanaCodeGroupItem>
</SolanaCodeGroup>

### Accounts Deserializers

A struct deriving all the accounts used by an instruction. The program can't read other accounts after. Here is possible to define if an account is initialized or modified by the instruction, if an account is using a PDA, and execute accounts validation.

<SolanaCodeGroup>
  <SolanaCodeGroupItem title="Rust" active>

  <template v-slot:default>

@[code](@/code/anchor/define-program/src/lib.rs)

  </template>

  <template v-slot:preview>

@[code](@/code/anchor/define-program/src/define-deserializer.preview.lib.rs)

  </template>

  </SolanaCodeGroupItem>
</SolanaCodeGroup>


#### Attributes

Some [`#[account(..)] attributes`][AccountAttr] usually used are:

| Attribute  | Description                                        |
|------------|----------------------------------------------------|
| init       | Tells to initialize the account.                   | 
| mut        | Tells to persists any changes made to the account. |
| payer      | Tells who fund for the account.                    |
| space      | Tells how many space is going to use the account. Value used for calculate the rent-exemption amount that is going to fund the payer.                           |
| has_one    | Checks if the target field on the account matches the target field in the struct deriving Accounts. |
| owner      | Checks if the account owner matches the target owner specified. |
| seeds      | Tells and checks the seeds for the PDA of the account. If using `init` and the PDA is used already or using `mut` and the seeds doesn't match, it'll throw an error. |
| dump      | Tells the value `u8` that completes the seeds to get a valid PDA. |

#### Types

Some [`structs types`][StructTypes] usually used are:

| Type  | Description                                                                                                                          |
|------------|--------------------------------------------------------------------------------------------------------------------------------------|
| [Signer][Signer]| Declares and enforces the constraint that the user **sign** the transaction- However, anchor doesn't fetch the data on that account. |
| [Account<'info, T>][AccountStruct]| Empty struct container that holds other custom accounts or structs. It checks ownership on deserialization.                          |
| [AccountInfo<'info>][AccountInfo]| Predefined struct with different fields. Used when there's nothing to deserialize like a SOL wallet or a signer.                     |
| [Program][ProgramStruct] | Program account container. It checks ownership on deserialization.                                                                   |

### Accounts

A struct defining all the data of an account. All the possible data types are show in the next section.

<SolanaCodeGroup>
  <SolanaCodeGroupItem title="Rust" active>

  <template v-slot:default>

@[code](@/code/anchor/define-program/src/lib.rs)

  </template>

  <template v-slot:preview>

@[code](@/code/anchor/define-program/src/define-account.preview.lib.rs)

  </template>

  </SolanaCodeGroupItem>
</SolanaCodeGroup>

::: details
The structure of accounts created using Anchor is:

`[8-byte-discriminator || borsh serialized data]`

The 8-byte-discriminator is created from the first 8 bytes of the `SHA256` hash of the account's type using the example above, `SHA256("account:Account")[..8]`. The `account:` is a fixed prefix.

Importantly, this allows a program to know for certain an account is indeed of a given type.
Without it, a program would be vulnerable to account injection attacks, where a malicious user
specifies an account of an unexpected type, causing the program to do unexpected things.

On account creation, this 8-byte discriminator doesn't exist, since the account storage is
zeroed. The first time an Anchor program mutates an account, this discriminator is prepended
to the account storage array and all subsequent accesses to the account (not using the `init` attribute) will check for this discriminator.
:::

## Calculating account space size

Accounts that don’t have any dynamically-sized data (Strings or Vecs) can just allow the Deserializer to automatically calculate the size, as the last example.[][ImplTutorial]

On the other side, if an account has dynamically-sized data (as the following account), it needs to declare an implementation function to calculate the account space size. The following account contains all the allowed data types in Solana.

<SolanaCodeGroup>
  <SolanaCodeGroupItem title="Rust" active>

  <template v-slot:default>

@[code](@/code/anchor/calculating-account-space-size/src/lib.rs)

  </template>

  <template v-slot:preview>

@[code](@/code/anchor/calculating-account-space-size/src/account.preview.lib.rs)

  </template>

  </SolanaCodeGroupItem>
</SolanaCodeGroup>

The following implementation [`impl`][Impl] function contains all the respective space sizes for each data type of the previously declared account.[][RustSizes] For `Strings`, the total size is a `String` discriminator (4 bytes) plus the length of the string. For `Vectors`, the total size is the maximum amount of possible elements in vector (capacity) multiplied by the vector data type plus the `Vec` discriminator (4 bytes).

<SolanaCodeGroup>
  <SolanaCodeGroupItem title="Rust" active>

  <template v-slot:default>

@[code](@/code/anchor/calculating-account-space-size/src/lib.rs)

  </template>

  <template v-slot:preview>

@[code](@/code/anchor/calculating-account-space-size/src/implementation-space.preview.lib.rs)

  </template>

  </SolanaCodeGroupItem>
</SolanaCodeGroup>

The following `Accounts Deserializer` applies the previously declared implementation. It’ll calculate the account’s space size on its initialization. The `#[instruction(...)]` attribute allows to pass the instruction inputs to the `Accounts Deserializer`, and consequently to the `impl`.

<SolanaCodeGroup>
  <SolanaCodeGroupItem title="Rust" active>

  <template v-slot:default>

@[code](@/code/anchor/calculating-account-space-size/src/lib.rs)

  </template>

  <template v-slot:preview>

@[code](@/code/anchor/calculating-account-space-size/src/deserializer.preview.lib.rs)

  </template>

  </SolanaCodeGroupItem>
</SolanaCodeGroup>

## Error Codes

| Error 	| Code 	| Description 	| 
|------	|-------	|-------------	|
| 100 | InstructionMissing | 8 byte instruction identifier not provided |     
| 101 | InstructionFallbackNotFound | Fallback functions are not supported |     |
| 102 | InstructionDidNotDeserialize | The program could not deserialize the given instruction |     |
| 103 | InstructionDidNotSerialize | The program could not serialize the given instruction |     |
| 120 | IdlInstructionStub | The program was compiled without idl instructions |     |
| 121 | IdlInstructionInvalidProgram | The transaction was given an invalid program for the IDL instruction |     |
| 140 | ConstraintMut | A mut constraint was violated |     |
| 141 | ConstraintBelongsTo | A belongs_to constraint was violated |     |
| 142 | ConstraintSigner | A signer constraint was violated |     |
| 143 | ConstraintRaw | A raw constraint as violated |     |
| 144 | ConstraintOwner | An owner constraint was violated |     |
| 145 | ConstraintRentExempt | A rent exempt constraint was violated |     |
| 146 | ConstraintSeeds | A seeds constraint was violated |     |
| 147 | ConstraintExecutable | An executable constraint was violated |     |
| 148 | ConstraintState | A state constraint was violated |     |
| 149 | ConstraintAssociated | An associated constraint was violated |     |
| 150 | ConstraintAssociatedInit | An associated init constraint was violated |     |
| 160 | AccountDiscriminatorAlreadySet | The account discriminator was already set on this account |     |
| 161 | AccountDiscriminatorNotFound | No 8 byte discriminator was found on the account |     |
| 162 | AccountDiscriminatorMismatch | 8 byte discriminator did not match what was expected |     |
| 163 | AccountDidNotDeserialize | Failed to deserialize the account |     |
| 164 | AccountDidNotSerialize | Failed to serialize the account |     |
| 165 | AccountNotEnoughKeys | Not enough account keys given to the instruction |     |
| 166 | AccountNotMutable | The given account is not mutable |     |
| 167 | AccountNotProgramOwned | The given account is not owned by the executing program |     |
| 180 | StateInvalidAddress | The given state account does not have the correct address |     |
| 299 | Deprecated | The API being used is deprecated and should no longer be used |     |

[Program]: https://docs.rs/anchor-lang/latest/anchor_lang/attr.program.html
[Context]: https://docs.rs/anchor-lang/latest/anchor_lang/struct.Context.html
[DeriveAccounts]: https://docs.rs/anchor-lang/latest/anchor_lang/derive.Accounts.html
[AccountAttr]: https://docs.rs/anchor-lang/latest/anchor_lang/attr.account.html
[AccountStruct]: https://docs.rs/anchor-lang/0.16.1/anchor_lang/prelude/struct.Account.html
[Signer]: https://docs.rs/anchor-lang/latest/anchor_lang/struct.Signer.html
[RustSizes]: https://doc.rust-lang.org/stable/std/mem/fn.size_of.html
[Impl]: https://doc.rust-lang.org/reference/items/implementations.html
[ImplTutorial]: https://imfeld.dev/writing/starting_with_solana_part04#test-infrastructure
[AnchorDocs]: https://project-serum.github.io/anchor/getting-started/introduction.html
[AccountInfo]: https://docs.rs/anchor-lang/0.16.1/anchor_lang/prelude/struct.AccountInfo.html
[StructTypes]: https://docs.rs/anchor-lang/0.16.1/anchor_lang/prelude/index.html#structs
[ProgramStruct]: https://docs.rs/anchor-lang/0.16.1/anchor_lang/prelude/struct.Program.html
[ProgramAccountStruct]: https://docs.rs/anchor-lang/0.16.1/anchor_lang/prelude/struct.ProgramAccount.html
